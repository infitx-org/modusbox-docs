= Polling Transaction (MBF) Events
:keywords: add_keywords_separated_by_commas
:imagesdir: images
:toc: macro
:toclevels: 2


The following guide explains how to poll for transaction (Master Business Function) events created on the JDE server.

== Getting Started
* Review the xref:jde-requirements.adoc[PortX JDE Connector Reqirements].
* Review the xref:jde-preliminary-setup.adoc[PortX JDE Connector Preliminary Setup].
* See the link:/https://docs.oracle.com/cd/E64610_01/EOADI/title.html[JD Edwards EnterpriseOne Applications Data Interface for Electronic Data Interchange Implementation Guide] for more information about requirements
* A basic understanding of Oracle’s JD Edwards EnterpriseOne™, Mule, the and the https://docs.mulesoft.com/anypoint-studio/v/6/download-and-launch-anypoint-studio[Anypoint™ Studio] interface is assumed.

=== Setup - Prodcessing Options

JDE outbound transactions require that you set a _Processing Option_ specifying a transaction type. Additionally, some entry programs enable you to specify a version of the Master Business Function Processing Options program that, in turn, enables you to specify a version of the Interoperability Processing Options program.

To enter a customer using the application *Customer Master Information (P03013)* setup processing options to enable interoperability. 

. Log into *JDE*.
. Open the Work With Interactive Versions Page.
. Change the processing options for this application. 
. Determine which version of the Master Business Function is being called by the application.
 
image:demo_poll_mbf_events/image1_demo_poll_mbf_events.png[image,width=601,height=332]
[start=5]
. Open the Processing Options Page
. Review the following processing options.

image:demo_poll_mbf_events/image2_demo_poll_mbf_events.png[image,width=601,height=347]


[start=7]
. Open the Work With Interactive Versions Page.
+
The Customer Master Business Function version that is used for the application is *ZJDE0002*.

image:demo_poll_mbf_events/image3_demo_poll_mbf_events.png[image,width=601,height=314]
[start=8]

. Review the Customer Master MBF (*P0100042*) processing options.

image:demo_poll_mbf_events/image4_demo_poll_mbf_events.png[image,width=601,height=381]
[start=9]
. If the *Transaction Type* is not set, set it to the appropriate value.

For more information on setting transaction types, please refer to the link:/https://docs.oracle.com/cd/E64610_01/EOADI/title.html[Oracle JD Edwards EnterpriseOne] documentation.


NOTE: Update AnyPoint Studio before starting a PortX JDE Connector project.

== Creating a New Mule Project

. Login to your Mule Application
. Create a new Mule Project
. Select *Mule Server 4.1.1 EE* or greater as your runtime.

image:demo_poll_mbf_events/image5_demo_poll_mbf_events.png[image,width=321,height=423]

=== Setting Project Dependencies

. In your *pom.xml* add the following to you *Repositories* section:

[source,xml]
----
<repository>
    <id>portx-repository-releases</id>
    <name>portx-repository-releases</name>
    <url>https://portx.jfrog.io/portx/portx-releases</url>
</repository>
----

[start=2]

. Add the following to your *Dependencies* section:

[source,xml]
----
<dependency>
<groupId>com.modus</groupId>
    <artifactId>mule-jde-connector</artifactId>
    <version>2.0.0</version>
    <classifier>mule-plugin</classifier>
</dependency>
<dependency>
    <groupId>com.jdedwards</groupId>
    <artifactId>jde-lib-bundle</artifactId>
    <version>1.0.0</version>
    <classifier>mule-4</classifier>
</dependency>
----
[start=3]

. Add or update the following to your *Plugins* section:

[source,xml]
----
<plugin>
    <groupId>org.mule.tools.maven</groupId>
    <artifactId>mule-maven-plugin</artifactId>
    <version>$\{mule.maven.plugin.version}</version>
    <extensions>true</extensions>
    <configuration>
        <sharedLibraries>
            <sharedLibrary>
                <groupId>com.jdedwards</groupId>
                <artifactId>jde-lib-bundle</artifactId>
            </sharedLibrary>
        </sharedLibraries>
    </configuration>
</plugin>
----

=== Required Files

. Copy the JD Edwards EntrpriseOne™ configuration files to the following folders within your project:

* Project *Root*
* *src/main/resources*

NOTE: If there is a requirement to use different configuration files per environment, you may create separate folders under *src/main/resources* corresponding to each environment as shown below.

image:demo_poll_mbf_events/image6_demo_poll_mbf_events.png[image,width=250,height=446]
[start=2]

. The *mule-arifact.json* file must be updated per environment as follows.

[source,json]
----
{
	"minMuleVersion": "4.1.4",
	"classLoaderModelLoaderDescriptor": {
		"id": "mule",
		"attributes": {
			"exportedResources": [
				"JDV920/jdeinterop.ini",
				"JDV920/jdbj.ini",
				"JDV920/tnsnames.ora",
				"JPY920/jdeinterop.ini",
				"JPY920/jdbj.ini",
				"JPY920/tnsnames.ora",
				"jdelog.properties",
				"log4j2.xml"
			],
			"exportedPackages": [
				"JDV920",
				"JPY920"
			],
			"includeTestDependencies": "true"
		}
	}
}
----

=== Other Considerations

To redirect the JD Edwards EntrpriseOne™ Logger to Mule Logger (allowing you to see the JDE activity in both Console and JDE files defined in the *jdelog.properties*), add the following *Async Loggers* to *log4j2.xml* file.

[source,xml]
<!-- JDE Connector wire logging -->
<AsyncLogger name="org.mule.modules.jde.handle.MuleHandler" level="INFO" />
<AsyncLogger name="org.mule.modules.jde.JDEConnector" level="INFO" />

=== Troubleshooting

If you are having trouble resolving all dependencies:

. Shut down AnyPoint Studio.
. Run the following command in the project *ROOT* folder from the terminal/command prompt.
[source]
mvn clean install

[start=3]
. Open AnyPoint Studio and check your dependencies again.

=== Configure the Global Element

include::{partialsdir}/configure-global-element.adoc[]

=== Creating a Scheduler for Your Flow

Create a simple flow to poll for outbound events coming from an application that uses a *Customer Master Business Function* to generate transactions, and write these to Files.

See xref:jde-requirements.adoc[Reqiriements] and xref:jde-preliminary-setup.adoc[Preliminary Setup] for setup details.

. In Anypoint Studio, go to the *Message Flow* tab.

image:demo_poll_mbf_events/image12_demo_poll_mbf_events.png[image,width=601,height=488]

[start=2]

. From the Mule Palette (top right), select *Scheduler* and drag it to the canvas.

image:demo_poll_mbf_events/image13_demo_poll_mbf_events.png[image,width=295,height=278]

[start=3]

. Select the *Scheduler* component from the canvas and inspect the properties window.
+
The Properties Window appears.
. Change the *Frequency* to *2min*.

image:demo_poll_mbf_events/image14_demo_poll_mbf_events.png[image,width=569,height=268]

== Poll for Transaction (MBF) Events

. In your Mule Pallet, locate the *JDE Connector* and select *Poll Events*. 
. Drag this to the canvas.

image:demo_poll_mbf_events/image15_demo_poll_mbf_events.png[image,width=190,height=187]

[start=3]

. Drag the connector over to the canvas. 
. Select the connector and review the properties window.
+
The Properties Window appears.
. Assign it a meaningful name (eg. *Call Poll Customer Master Events*).

image:demo_poll_mbf_events/image16_demo_poll_mbf_events.png[image,width=601,height=290]

[start=6]

. Under the *General* section, click the drop-down for *Operation Name*.
. Select *Capture Event Transactions*.

image:demo_poll_mbf_events/image17_demo_poll_mbf_events.png[image,width=601,height=294]

[start=8]

. Assign the input parameters by either entering the payload values manually, or via the *Show Graphical View* button.

image:demo_poll_mbf_events/image18_demo_poll_mbf_events.png[image,width=601,height=294]
[start=9]

. Drag the inputs to outputs, or double-click the *output parameter* to add to your edit window.
. Change as required.

image:demo_poll_mbf_events/image19_demo_poll_mbf_events.png[image,width=601,height=212]

=== Troubleshooting
If the operation fails (possibly due to a timeout), the following message appears.

image:demo_poll_mbf_events/troubleshoot_timeout_message.png[image,width=345,height=115]

Review the *Timeout* settings in Anypoint Studio 's *Preferences*.

. Go to *Window > Preferences* menu.

image:demo_poll_mbf_events/troubleshoot_preferences_menu.png[image,width=154,height=199]

[start=2] 

. Go to *Anypoint Studio > DataSense* and change the *DataSense Connection Timeout* setting as demonstrated below.

image:demo_poll_mbf_events/troubleshoot_datasense_timeout.png[image,width=622,height=551]

[start=3]

. Go to *Anypoint Studio > Tooling* and change the *Default Connection Timeout* and *Default Read Timeout* settings as demonstrated below.

image:demo_poll_mbf_events/troubleshoot_timeout_tooling.png[image,width=622,height=551]

=== Set Payload Output

. In your Mule Palette select *Core* and scroll down to *Transformers*, or type *Payload* in the search bar.

image:demo_poll_mbf_events/image20_demo_poll_mbf_events.png[image,width=277,height=209]

[start=2]

. Drag and drop the *Set Payload* to your canvas.

image:demo_poll_mbf_events/image21_demo_poll_mbf_events.png[image,width=360,height=175]

[start=3]

. Select the *Set Payload* component and review the *Properties*.
+
The Properties Window appears.

image:demo_poll_mbf_events/image22_demo_poll_mbf_events.png[image,width=601,height=157]

[start=4]

. Change the payload to reflect the desired output.
. Save your project.

image:demo_poll_mbf_events/image23_demo_poll_mbf_events.png[image,width=601,height=245]

[start=6]

. On the *MIME Type* tab, select *application/xml*.

image:demo_poll_mbf_events/image24_demo_poll_mbf_events.png[image,width=399,height=216]

=== Check Transactions are Polled 

. From the Mule Palette, select and drag the *Choice* component.

image:demo_poll_mbf_events/image25_demo_poll_mbf_events.png[image,width=344,height=255]

image:demo_poll_mbf_events/image26_demo_poll_mbf_events.png[image,width=578,height=258]

[start=2]

. Select the *When* statement and review the properties.
+
The Properties Window appears.

. Enter the following expression to check that transactions exist.

image:demo_poll_mbf_events/image27_demo_poll_mbf_events.png[image,width=545,height=170]


=== Check the Scheduler

Check if the Scheuder failed to return transactions.

. In your Mule Pallet, add a *Logger* to the *Default* condition. 

image:demo_poll_mbf_events/image28_demo_poll_mbf_events.png[image,width=306,height=254]

[start=2]

. Drag the *logger component* to the canvas.
[start=3]

. Select and review the properties

image:demo_poll_mbf_events/image29_demo_poll_mbf_events.png[image,width=601,height=529]
[start=4]

. Enter an appropriate message.

=== Iterate Over Retrieved Transactions

If transactions are retrieved (*When* condition is true), iterate over all transactions that have been retrieved.

. Drag the *For Each* component from the Mule Palette to your canvas.

image:demo_poll_mbf_events/image30_demo_poll_mbf_events.png[image,width=207,height=259]

[start=2] 

. Select the *Component* and review the *Properties*.

image:demo_poll_mbf_events/image31_demo_poll_mbf_events.png[image,width=601,height=251]

[start=3]

. In *Collection*, enter the *Transaction Collection* as demonstrated below.

image:demo_poll_mbf_events/image32_demo_poll_mbf_events.png[image,width=542,height=265]

[start=4]

. Drag the *Set Variable* component to your canvas.
. Select and review the *Properties*.

image:demo_poll_mbf_events/image33_demo_poll_mbf_events.png[image,width=601,height=283]

[start=6]

. Set the *Variable Name*.
. Click *Show Graphical View*.

image:demo_poll_mbf_events/image34_demo_poll_mbf_events.png[image,width=601,height=236]

[start=8]

. Set the *Variable Value* to the *filename* you want to create.
. Click *Done*.

image:demo_poll_mbf_events/image35_demo_poll_mbf_events.png[image,width=601,height=149]

[start=9]

. From your Mule Palette, select the *File > Write* component and drag it to the canvas.

image:demo_poll_mbf_events/image36_demo_poll_mbf_events.png[image,width=298,height=268]

image:demo_poll_mbf_events/image37_demo_poll_mbf_events.png[image,width=601,height=252]

[start=10]

. Select and review the *Properties*.

. Under the *Basic Settings*, click the *Add* button next to *Connector Configuration*.

image:demo_poll_mbf_events/image38_demo_poll_mbf_events.png[image,width=601,height=294]

[start=11]

. In the *Working Directory* field, enter the path where you want to write your file to.
. Click *OK*.

image:demo_poll_mbf_events/image39_demo_poll_mbf_events.png[image,width=601,height=607]

[start=13]

. Under the *General* section, click the *Switch to Expression* button and enter the *Variable Name*.

image:demo_poll_mbf_events/image40_demo_poll_mbf_events.png[image,width=596,height=292]

=== Testing the Mule Flow

To test your flow, start the Mule Application.

. Go to the *Run menu* and select *Run*.

image:demo_poll_mbf_events/image41_demo_poll_mbf_events.png[image,width=567,height=376]

After your project is deployed, you can test you flow by logging into JDE.

. Go to the *Customer Master Information* Application (P03013 ZJDE0002).

NOTE: This must be a version that is configured for interoperability (See <<Requirements>>)

image:demo_poll_mbf_events/image42_demo_poll_mbf_events.png[image,width=601,height=430]

[start=2]

. Make a change to the *customer* and check your output path for a created file.

image:demo_poll_mbf_events/image43_demo_poll_mbf_events.png[image,width=601,height=98]

The *Transaction XML* is written to the file.

image:demo_poll_mbf_events/image44_demo_poll_mbf_events.png[image,width=315,height=280]

=== Handling Exceptions

. From your Mule Pallete, select and drag the *Error Handler* to your canvas. 

image:demo_poll_mbf_events/image45_demo_poll_mbf_events.png[image,width=294,height=334]

image:demo_poll_mbf_events/image46_demo_poll_mbf_events.png[image,width=601,height=424]

[start=2]

. Select and drag *On Error Continue* into the *Error Handler*.

image:demo_poll_mbf_events/image47_demo_poll_mbf_events.png[image,width=247,height=129]

[start=3]

. Select the *On Error Continue* scope, and under *Type* enter *JDE:ERROR_PROCESSING_POLL_EVENT*.

image:demo_poll_mbf_events/image48_demo_poll_mbf_events.png[image,width=447,height=324]

NOTE: The operation error types can be seen when selecting the operation on your canvas by going to *Error Mapping* and clicking *add*. You may also map this error to an application specific error.

image:demo_poll_mbf_events/image49_demo_poll_mbf_events.png[image,width=250,height=291]

[start=4]

. Drag the *Set Payload* component to the *Error Handler* and set an appropriate message.

image:demo_poll_mbf_events/image50_demo_poll_mbf_events.png[image,width=442,height=298]