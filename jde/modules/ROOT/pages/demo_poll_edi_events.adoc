= Polling for EDI Events
:keywords: add_keywords_separated_by_commas
:imagesdir: images
:toc: macro
:toclevels: 2


The following guide explains how to Poll for EDI Events created on the JD Edwards EnterpriseOne server.

== Getting Started
* Review the PortX JDE Connector xref:jde-requirements.adoc[Reqirements].
* Review the PortX JDE Connector xref:jde-preliminary-setup.adoc[Preliminary Setup].
* See the link:/https://docs.oracle.com/cd/E64610_01/EOADI/title.htm[JD Edwards EnterpriseOne Applications Data Interface for Electronic Data Interchange Implementation Guide] for more information about requirements.
* A basic understanding of Oracle’s JD Edwards EnterpriseOne™, Mule, the and the https://docs.mulesoft.com/anypoint-studio/v/6/download-and-launch-anypoint-studio[Anypoint™ Studio] interface is assumed.

=== Setup - Processing Option
JDE outbound transactions require that you set a _Processing Option_ specifying EDI information.

To Generate an Order Acknowledgment (*855/ORDSP*) document, you must setup its processing options to enable interoperability. 

. Log into JDE.
. Open the Batch Versions Page.
. Change the processing options for this application. 
. Determine which version of the Print Invoices (*R42565*) is being used. 


image:demo_poll_edi_events/image1_demo_poll_edi_events.png[image,width=482,height=437]

[start=5]
. Open the Processing Options Page
. Review the processing options.

image:demo_poll_edi_events/image2_demo_poll_edi_events.png[image,width=478,height=455]
[start=7]
. Open the Work With Flat File Cross-Refrence Page.
. Inform to JDE connector the *EDI outbound*.


image:demo_poll_edi_events/image3_demo_poll_edi_events.png[image,width=601,height=312]

Using Flat File Cross-Reference (*P47002*) form, the *Work With Flat File Cross-Reference* adds the following record:

[cols=",,",options="header",]
|===
|*Table* |*Record Type* |*Type Description*
|F47026 |1 |Header
|F47027 |2 |Detail
|F4706 |6 |Address
|F4714 |7 |Header Text
|F4715 |8 |Detail Text
|===

Refer to the link:https://docs.oracle.com/cd/E64610_01/index.htm[Oracle JD Edwards EnterpriseOne] documentation for more information.

== Creating a New Mule Project 

. Login to your Mule Application
. Create a new Mule Project.
. Select *Mule Server 4.1.1 EE* or greater as runtime.

image:demo_poll_edi_events/image4_demo_poll_edi_events.png[image,width=345,height=463]

=== Setting Project Dependencies

. In your *pom.xml* file, add the following to your *Repositories* section.
[source,xml]
----
<repository>
    <id>portx-repository-releases</id>
    <name>portx-repository-releases</name>
    <url>https://portx.jfrog.io/portx/portx-releases</url>
</repository>
----
[start=2]
. Add the following to your *Dependencies* section.

[source,xml]
----
<dependency>
<groupId>com.modus</groupId>
    <artifactId>mule-jde-connector</artifactId>
    <version>2.0.0</version>
    <classifier>mule-plugin</classifier>
</dependency>
<dependency>
    <groupId>com.jdedwards</groupId>
    <artifactId>jde-lib-bundle</artifactId>
    <version>1.0.0</version>
    <classifier>mule-4</classifier>
</dependency>
----
[start=3]

. Add the following to your *Plugins* section.
[source,xml]
----
<plugin>
    <groupId>org.mule.tools.maven</groupId>
    <artifactId>mule-maven-plugin</artifactId>
    <version>$\{mule.maven.plugin.version}</version>
    <extensions>true</extensions>
    <configuration>
        <sharedLibraries>
            <sharedLibrary>
                <groupId>com.jdedwards</groupId>
                <artifactId>jde-lib-bundle</artifactId>
            </sharedLibrary>
        </sharedLibraries>
    </configuration>
</plugin>
----

=== Required Files

. Copy your JD Edwards EntrpriseOne™ configuration files to the following folders within your project.

* Project *Root*
* *src/main/resources*

NOTE: If you are required to use different configuration files per environment, you may create separate folders under *src/main/resources* corresponding to each environment as shown below.

image:demo_poll_edi_events/image5_demo_poll_edi_events.png[image,width=250,height=446]
[start=2]

. Update the *mule-arifact.json* file per environment as shown below.

[source,json]
----
{
	"minMuleVersion": "4.1.4",
	"classLoaderModelLoaderDescriptor": {
		"id": "mule",
		"attributes": {
			"exportedResources": [
				"JDV920/jdeinterop.ini",
				"JDV920/jdbj.ini",
				"JDV920/tnsnames.ora",
				"JPY920/jdeinterop.ini",
				"JPY920/jdbj.ini",
				"JPY920/tnsnames.ora",
				"jdelog.properties",
				"log4j2.xml"
			],
			"exportedPackages": [
				"JDV920",
				"JPY920"
			],
			"includeTestDependencies": "true"
		}
	}
}
----

=== Other Considerations

To redirect the JD Edwards EntrpriseOne™ Logger to the Mule Logger (to see JDE activity in both consoles and JDE files defined in the *jdelog.properties*), you may add the following _Async Loggers_ to *log4j2.xml* file.

[source,xml]
<!-- JDE Connector wire logging -->
<AsyncLogger name="org.mule.modules.jde.handle.MuleHandler" level="INFO" />
<AsyncLogger name="org.mule.modules.jde.JDEConnector" level="INFO" />

=== Troubleshooting

If you are having trouble resolving all dependencies:

. Shut down AnyPoint Studio.
. Run the following command in the project root folder from the terminal/command prompt.
[source]
mvn clean install

[start=3]
. Open AnyPoint Studio and check dependencies again.

== Configure the Global Element
include::{partialsdir}/configure-global-element.adoc[]

== Creating a Scheduler for Your Flow

This use case example creates a simple flow to poll for outbound events coming from an application that uses *Print Invoices* (*R42565*) to generate a *Order Acknowledgement (855/ORDSP)* EDI document, and writes to each of these files.

See xref:jde-requirements.adoc[Requirements] setup details.

. In Anypoint Studio, go to the *Message Flow* tab.

image:demo_poll_edi_events/image11_demo_poll_edi_events.png[image,width=601,height=457]

[start=2]

. From the Mule Palette (top right), select *Scheduler*, and drag it to the canvas.

image:demo_poll_edi_events/image12_demo_poll_edi_events.png[image,width=295,height=278]

[start=3]

. Select the *Scheduler* component from the canvas, and inspect the properties window, and change the Frequency to *2min*.

image:demo_poll_edi_events/image13_demo_poll_edi_events.png[image,width=498,height=336]

== Poll for EDI Events

. In the Mule Pallet locate the *JDE* Connector, and select *Edi outbound*.
. Drag this to the canvas.

image:demo_poll_edi_events/image14_demo_poll_edi_events.png[image,width=221,height=191]

[start=3]

. Drag the *JDE* connector over to the canvas. 
. Select the connector and review the properties window.
+
The Propertes Window appears.
. Under the *General* section, enter a meaningful *Display Name* (eg. Call _Poll Order Acknowledgement EDI_).

image:demo_poll_edi_events/image15_demo_poll_edi_events.png[image,width=410,height=258]

[start=6]

. Under the *General* section, click the drop-down for *Operation Name*, and select *Capture EDI Transactions*.

image:demo_poll_edi_events/image16_demo_poll_edi_events.png[image,width=589,height=302]

=== Troubleshooting
If the operation fails (possibly due to a timeout), the following message appears.

image:demo_poll_edi_events/troubleshoot_timeout_message.png[image,width=345,height=115]

Review the *timeout* settings in Anypoint Studio's *Preferences*.

. Go the the *Window > Preferences* menu.
+
The Prefrences Window appears.

image:demo_poll_edi_events/troubleshoot_preferences_menu.png[image,width=154,height=199]

[start=2]

. Go to *Anypoint Studio > DataSense* and change the *DataSense Connection Timeout* setting as shown below.

image:demo_poll_edi_events/troubleshoot_datasense_timeout.png[image,width=622,height=551]

[start=3]

. Go to *Anypoint Studio > Tooling* and change the *Default Connection Timeout* and *Default Read Timeout* settings as shown below.

image:demo_poll_edi_events/troubleshoot_timeout_tooling.png[image,width=622,height=551]

=== Setting Parameters
. Return to the Properties Window.
. Under the *General* section, assign the *Input Parameters*.
. Either enter the *payload values* manually, or via the *Show Graphical View* button.

image:demo_poll_edi_events/image17_demo_poll_edi_events.png[image,width=601,height=292]
[start=4]

. Drag the *Inputs* to *Outputs*, or double-click the *output parameter* to add to your edit window.
. Change as required.

image:demo_poll_edi_events/image18_demo_poll_edi_events.png[image,width=601,height=179]

=== Set Payload Output

. In the Mule Palette choose one of the following:
* Select *Core* and scroll down to *Transformers*.
* Type *Payload* in the search bar.

image:demo_poll_edi_events/image19_demo_poll_edi_events.png[image,width=277,height=209]

[start=2]

. Drag and drop the *Set Payload* to your canvas.

image:demo_poll_edi_events/image20_demo_poll_edi_events.png[image,width=365,height=192]

[start=3]

. Select the *Set Payload* component, and review the properties.
+
The Properties Window appears.
image:demo_poll_edi_events/image21_demo_poll_edi_events.png[image,width=601,height=157]
[start=4]

. In the *Settings* section, change the *Payload* to reflect the desired output.
. Save your project.

image:demo_poll_edi_events/image22_demo_poll_edi_events.png[image,width=601,height=216]

[start=6]

. Click the *MIME Type* tab.
+
The MIME Type window appears.
. Under *MIME Type*, select *application/xml*.

image:demo_poll_edi_events/image23_demo_poll_edi_events.png[image,width=399,height=216]

Your payload output is set.

=== Check Transactions are Polled

. From the Mule Palette, select and drag the *Choice* component.

image:demo_poll_edi_events/image24_demo_poll_edi_events.png[image,width=344,height=255]

image:demo_poll_edi_events/image25_demo_poll_edi_events.png[image,width=600,height=259]

[start=2]

. Select the *When* statement, and review the properties.
+
The Properties Window appears.
. Enter the following expression to check that the transactions exist.

image:demo_poll_edi_events/image26_demo_poll_edi_events.png[image,width=545,height=170]

=== Check the Scheduler 
Check to see when the scheduler returned no transactions.

. Add a *logger* to the Default condition. 

. From you Mule Palette, drag the *logger* component to the canvas.

image:demo_poll_edi_events/image27_demo_poll_edi_events.png[image,width=306,height=254]

[start=3]

. Select and review the properties.
+
The Properties Window Appears.
. Enter an appropriate message.

image:demo_poll_edi_events/image28_demo_poll_edi_events.png[image,width=601,height=520]

=== Iterate Over Retrieved Transactions
This step applies if transactions are retrieved (the _When_ condition is true). 

. Drag the *For Each* component from the *out* palette, to your canvas.

image:demo_poll_edi_events/image29_demo_poll_edi_events.png[image,width=207,height=259]

[start=2]

. Select the component, and review the properties.
+
The Properties Window Appears.

image:demo_poll_edi_events/image30_demo_poll_edi_events.png[image,width=601,height=265]

[start=3]

. In *Settings*, under *Collection* enter the *Transaction Collection* as shown below.

image:demo_poll_edi_events/image31_demo_poll_edi_events.png[image,width=542,height=265]

[start=4]

. Drag the *Set Variable* component to your canvas.
. Select and review the properties.
+
The Properties Window Appears.

image:demo_poll_edi_events/image32_demo_poll_edi_events.png[image,width=601,height=274]

[start=6]

. Set the *Variable Name*.
. Click *Show Graphical View*.

image:demo_poll_edi_events/image33_demo_poll_edi_events.png[image,width=601,height=236]

[start=8]

. Set the *Variable* value to the filename you want to create.
. Click *Done*.

image:demo_poll_edi_events/image34_demo_poll_edi_events.png[image,width=600,height=194]

[start=10]

. From your Mule Palette, drag the *X12 EDI > Write* component to your canvas.

NOTE: If you do not have *X12 EDI> Write* component, you must download it from AnyPoint Exchange.

image:demo_poll_edi_events/image35_demo_poll_edi_events.png[image,width=274,height=225]

[start=11]

. Review your component.
+
The Properties Window Appears.

. Create a Connector Configuration by clicking the *Add* button.

image:demo_poll_edi_events/image36_demo_poll_edi_events.png[image,width=601,height=225]

=== Change Schema Definitions to Inline
. Open Global Element Properties window.
. Click *Add* and enter the required schema (this points to a schema file).

NOTE: Download schema if you do not have it.

image:demo_poll_edi_events/image37_demo_poll_edi_events.png[image,width=344,height=348]

[start=2]

. Under the *Identity* Tab, enter the details as required.
. Click *OK*

image:demo_poll_edi_events/image38_demo_poll_edi_events.png[image,width=351,height=356]

[start=4]
. Return to the Properties Window.
. Click the *Show Graphical View* button.

image:demo_poll_edi_events/image39_demo_poll_edi_events.png[image,width=601,height=226]

[start=6]

. Enter the *Payload* as required.

[source,json]
%dw 2.0
output application/java
---
{
	Interchange: {
		ISA01: "00",
		ISA03: "00",
		ISA05: "ZZ",
		ISA06: "Modusbox",
		ISA07: "ZZ",
		ISA08: "Customer",
		ISA09: now,
		ISA10: now,
		ISA11: "^",
		ISA12: "00501",
		ISA13: payload.TRANSACTION.COLUMN_EDOC,
		ISA14: "0",
		ISA15: "P",
		ISA16: ">"
	},
	Group: {
        GS01: "PR",
        GS02: "DEMO",
        GS03: "PARTNER",
        GS04: now,
        GS05: now,
        GS06: 1111,
        GS07: "X",
        GS08: "005010"
	},
	SetHeader: {
        ST01: "855",
        ST02: "530006100"
	},
    Heading: {
	    "0200_BAK": {
	            BAK01: "00",
	            BAK02: "AD",
	            BAK03: "PO01",
	            BAK04: now
            		}
	},
	Detail: {
		"0100_PO1_Loop": payload.TRANSACTION.TABLE_2.FORMAT_TABLE_F47027 
					map ((FORMAT_TABLE_F47027 , index) -> 
						{
                        "0100_PO1": {
                                PO102: FORMAT_TABLE_F47027.COLUMN_UORG as Number,
                                PO103: FORMAT_TABLE_F47027.COLUMN_UOM,
                                PO104: FORMAT_TABLE_F47027.COLUMN_UPRC as Number,
                                PO105: "CP",
                                PO106: "CB",
                                PO107: FORMAT_TABLE_F47027.COLUMN_LITM as String
                        },
                        "0500_PID_Loop": [{
                                "0500_PID": {
                                        PID01: "F",
                                        PID05: FORMAT_TABLE_F47027.COLUMN_DSC1 replace /,/ with ""
                                }
                        }]
                })
        },
        Summary: {
                "0100_CTT_Loop": {
                        "0100_CTT": {
                                CTT01: sizeOf(payload.TRANSACTION.TABLE_2.FORMAT_TABLE_F47027) ,
                                CTT02: 1
                        }
                }
        }
}

[start=6]

. From your Mule Palette, Select the *File > Write* component, and drag it to your canvas.

image:demo_poll_edi_events/image40_demo_poll_edi_events.png[image,width=298,height=268]

image:demo_poll_edi_events/image41_demo_poll_edi_events.png[image,width=601,height=252]
[start=7]

. Select and review the *Properties*.
+
The Properties Window appears.
. Under the *Basic Settings*, click the *Add* button next to *Connector Configuration*.

image:demo_poll_edi_events/image42_demo_poll_edi_events.png[image,width=601,height=294]

[start=9]

. In the *Working* Directory field, enter the path where you want to write the file to.
. Click *OK*.

image:demo_poll_edi_events/image43_demo_poll_edi_events.png[image,width=601,height=607]

[start=11]

. Under the *General* section, click the *Switch to Expression* button.
. Enter the *Variable Name*.

image:demo_poll_edi_events/image44_demo_poll_edi_events.png[image,width=596,height=292]

Your schema definitons are changed.

== Testing the Mule Flow

. Start the Mule application. 

. Go to the *Run* menu, and select *Run*.

image:demo_poll_edi_events/image45_demo_poll_edi_events.png[image,width=567,height=376]

[start=3]

. When your project is deployed, log into JDE.

. Go to the *Customer Master Information* Application (*P03013 ZJDE0002*).
+
The Customer Master Revision Page appears.

NOTE: Use a version of JDE that is configured for interoperability. 
See xref:jde-requirements.adoc[Reqirements] for more information.

image:demo_poll_edi_events/image46_demo_poll_edi_events.png[image,width=601,height=430]
[start=5]

. Make a change to the customer.
. Check your output path for a created file.

image:demo_poll_edi_events/image47_demo_poll_edi_events.png[image,width=601,height=98]

The *Transaction XML* is written to the file.

image:demo_poll_edi_events/image48_demo_poll_edi_events.png[image,width=315,height=280]

=== Handling Exceptions

. From your Mule Pallete, select and drag the *Error Handler* to your canvas.

image:demo_poll_edi_events/image49_demo_poll_edi_events.png[image,width=294,height=334]


image:demo_poll_edi_events/image50_demo_poll_edi_events.png[image,width=601,height=424]

[start=2]

. Select and drag *On Error Continue* into the *Error Handler*.

image:demo_poll_edi_events/image51_demo_poll_edi_events.png[image,width=247,height=129]

[start=3]

. Select the *On Error Continue* scope, and under *Type* enter JDE:ERROR_PROCESSING_POLL_EVENT.

image:demo_poll_edi_events/image52_demo_poll_edi_events.png[image,width=447,height=324]

NOTE: Operation error types are visable when you select the operation on your canvas by going to *Error Mapping*, and clicking *Add*. You may also map this error to an application specific error.

image:demo_poll_edi_events/image53_demo_poll_edi_events.png[image,width=250,height=291]

[start=4]

. Drag the *Set Payload* component to the *Error Handler*, and set an appropriate message.

image:demo_poll_edi_events/image54_demo_poll_edi_events.png[image,width=442,height=298]
